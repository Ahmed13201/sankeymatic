<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>My sankey testing ground</title>
<style>

#chart {
  height: 500px;
}

.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

/* GRAY links between nodes. fill should be nonexistent; stroke is all. */
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

/* near-black links when hovering: */
.link:hover { stroke-opacity: .5; }

/* style all the label text: */
svg { font: 12px sans-serif; }

</style>
</head>
<body>

<!-- script src="http://d3js.org/d3.v2.min.js?2.9.1"></script -->
<script src="d3.v2.js"></script>
<script src="sankey.js"></script>
<script>
function render_sankey() {
    "use strict";

    var raw_json_nodes, raw_json_paths, cleaned_json, margin, width, height,
        dollars_format, colorlist, svg, sankey, path, link, node;

    //console.log('inside function');
    raw_json_nodes = document.getElementById('json_nodes_in').value;
    raw_json_paths = document.getElementById('json_paths_in').value;
    //console.log(raw_json_nodes);
    //console.log(raw_json_paths);
    cleaned_json = {
        "nodes": JSON.parse("[" + raw_json_nodes + "]"),
        "links": JSON.parse("[" + raw_json_paths + "]")
    };
    // console.log(cleaned_json);

    // define dimensions:
    // 1 x 6 x 1 x 1 margin:
    margin = {top: 1, right: 1, bottom: 6, left: 1};
    //  960 x 500 space:
    width = 960 - margin.left - margin.right;
    height = 500 - margin.top - margin.bottom;
    //console.log("width=",width);

    // set up: formatting function for numeric labels
    dollars_format = function (d) { return '$' + d3.format(",.0f")(d); };

    colorlist = d3.scale.category20(); // produces a list of 20 compatible colors to choose from

    // establish svg space with the defined dimensions:
    svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// create a sankey object, node widths constant at 15 and padding 10
    sankey = d3.sankey()
        .nodeWidth(15)
        .nodePadding(10)
        .size([width, height])
        .nodes(cleaned_json.nodes)
        .links(cleaned_json.links)
        .layout(32);

    // path is a function returning coordinates and specs for each flow area
    path = sankey.link();

    link = svg.append("g").selectAll(".link")
        .data(cleaned_json.links)
        .enter().append("path")
        .attr("class", "link")
        .attr("d", path) // embed coordinates
        .style("stroke-width", function (d) { return Math.max(1, d.dy); })
        .sort(function (a, b) { return b.dy - a.dy; });

    link.append("title")    // Make tooltips for flows
        .text(function (d) { return d.source.name + " â†’ " + d.target.name + "\n" + dollars_format(d.value); });

    // define drag function for use in node definitions
    function dragmove(d) {
        // Calculate new position
        d.y = Math.max(0, Math.min(height - d.dy, d3.event.y));
        d3.select(this).attr(
            "transform",
            "translate(" + d.x + "," + d.y + ")"
        );
        // re-render
        sankey.relayout();
        // ??
        link.attr("d", path);
    }

    node = svg.append("g").selectAll(".node")
        .data(cleaned_json.nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
        .call(d3.behavior.drag()
            .origin(function (d) { return d; })
            .on("dragstart", function () { this.parentNode.appendChild(this); })
            .on("drag", dragmove)
            );

    node.append("rect")
        .attr("height", function (d) { return d.dy; })
        .attr("width", sankey.nodeWidth())
        .style("fill", function (d) {
            d.color = colorlist(d.name.replace(/ [\w\W]*/, ""));
            return d.color;
        })
        .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
        .append("title")
        .text(function (d) { return d.name + "\n" + dollars_format(d.value); });

    node.append("text")
        .attr("x", -6)
        .attr("y", function (d) { return d.dy / 2; })
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .attr("transform", null)
        .text(function (d) { return d.name; })
        .filter(function (d) { return d.x < width / 2; })
        .attr("x", 6 + sankey.nodeWidth())
        .attr("text-anchor", "start");
}


</script>
<form onsubmit="document.getElementById('chart').innerHTML = ''; render_sankey(); return false;">
<textarea id="json_nodes_in" placeholder="Nodes go here" rows="15" cols="40"></textarea>
<textarea id="json_paths_in" placeholder="Paths go here" rows="15" cols="40"></textarea>
<button name="json_submit" type="submit">
Render</button>
</form>

<p id="chart">

</body></html>